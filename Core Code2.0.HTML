<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>PCAR3 Python Code Generator - Company</title>
  <style>
    body {
      background: #f5f7fa;
      font-family: 'Segoe UI', Arial, sans-serif;
      margin: 0;
      padding: 0;
      color: #222;
    }
    .intel-header {
      background: #0071C5;
      color: #fff;
      padding: 24px 0 16px 0;
      text-align: center;
      box-shadow: 0 2px 8px rgba(0,0,0,0.04);
      position: relative;
    }
    .intel-logo {
      height: 48px;
      vertical-align: middle;
      margin-right: 16px;
      border-radius: 8px;
      background: #fff;
      box-shadow: 0 2px 8px rgba(0,0,0,0.04);
    }
    .container {
      max-width: 1400px;
      margin: 32px auto 24px auto;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 4px 24px rgba(0,113,197,0.08);
      padding: 32px 32px 24px 32px;
    }
    .plb-block {
      border: 1px solid #e0e6ed;
      margin: 18px 0;
      padding: 18px 12px 12px 12px;
      position: relative;
      border-radius: 8px;
      background: #f8fafc;
      box-shadow: 0 2px 8px rgba(0,113,197,0.03);
    }
    .plb-header {
      display: flex;
      align-items: center;
      margin-bottom: 12px;
    }
    .plb-toggle-btn {
      background: transparent;
      color: #666;
      border: 1px solid #d0d7de;
      border-radius: 4px;
      padding: 2px 8px;
      cursor: pointer;
      font-size: 12px;
      margin-right: 12px;
      transition: all 0.2s;
      min-width: 50px;
    }
    .plb-toggle-btn:hover {
      background: #f3f4f6;
      border-color: #0071C5;
      color: #0071C5;
    }
    .delete-plb-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      background: #fff;
      color: #0071C5;
      border: 1px solid #0071C5;
      border-radius: 6px;
      padding: 2px 10px;
      cursor: pointer;
      transition: background 0.2s, color 0.2s;
    }
    .delete-plb-btn:hover {
      background: #0071C5;
      color: #fff;
    }
    .plb-content { transition: all 0.3s ease; }
    .plb-collapsed .plb-content { display: none; }

    .plb-row {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      margin-bottom: 10px;
    }
    .param-group {
      margin-right: 24px;
      margin-bottom: 6px;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      background: #f0f6fa;
      border-radius: 6px;
      border: 1px dashed #0071C5;
      padding: 4px 12px;
    }
    .param-group label {
      margin-right: 18px;
      margin-bottom: 4px;
    }

    .item-block {
      margin-left: 20px;
      margin-bottom: 8px;
      background: #fff;
      border: 1px dashed #b3c6d9;
      padding: 8px 8px 8px 0;
      display: flex;
      align-items: center;
      justify-content: space-between;
      user-select: text;
      border-radius: 6px;
      box-shadow: 0 1px 4px rgba(0,113,197,0.03);
      flex-wrap: wrap;
    }
    .item-content {
      display: flex;
      align-items: center;
      flex-wrap: wrap;
      flex: 1;
      min-width: 0;
    }
    .item-actions {
      display: flex;
      align-items: center;
      flex-shrink: 0;
      margin-left: 16px;
    }
    .drag-handle {
      cursor: grab;
      user-select: none;
      margin-right: 12px;
      font-size: 20px;
      color: #0071C5;
      flex-shrink: 0;
    }

    input[type="text"], select, textarea {
      font-size: 15px;
      padding: 4px 8px;
      margin: 0 12px 0 8px;
      border: 1px solid #b3c6d9;
      border-radius: 5px;
      background: #fff;
      transition: border 0.2s;
    }
    textarea {
      font-family: 'Fira Mono', 'Consolas', 'Menlo', monospace;
      min-width: 520px;
      min-height: 72px;
      resize: vertical;
      line-height: 1.35;
    }
    input[type="text"]:focus, select:focus, textarea:focus {
      border: 1.5px solid #0071C5;
      outline: none;
    }
    label { margin-right: 16px; margin-left: 8px; }

    .item-block button {
      margin-left: 16px;
      background: #fff;
      color: #0071C5;
      border: 1px solid #0071C5;
      border-radius: 5px;
      padding: 2px 10px;
      cursor: pointer;
      transition: background 0.2s, color 0.2s;
    }
    .item-block button:hover { background: #0071C5; color: #fff; }

    button {
      background: #0071C5;
      color: #fff;
      border: none;
      border-radius: 6px;
      padding: 7px 18px;
      font-size: 15px;
      margin: 8px 8px 8px 0;
      cursor: pointer;
      transition: background 0.2s;
      box-shadow: 0 2px 8px rgba(0,113,197,0.06);
    }
    button:hover { background: #005fa3; }

    h2 { margin: 0 0 12px 0; font-weight: 500; letter-spacing: 1px; }
    h3 { margin-top: 32px; color: #0071C5; font-weight: 400; }

    #codebox {
      background: #f4f7fa;
      border: 1px solid #e0e6ed;
      border-radius: 8px;
      padding: 18px;
      font-family: 'Fira Mono', 'Consolas', 'Menlo', monospace;
      font-size: 15px;
      color: #222;
      margin-top: 10px;
      overflow-x: auto;
      white-space: pre;
    }
    .intel-footer {
      text-align: center;
      color: #888;
      font-size: 13px;
      margin: 32px 0 12px 0;
    }

    /* QueryTid inline layout */
    .pre-querytid, .post-querytid {
      display: flex;
      flex-direction: row;
      gap: 18px;
      align-items: center;
      margin-top: 6px;
      margin-bottom: 6px;
    }
    .pre-querytid label, .post-querytid label {
      margin-right: 0;
      min-width: 110px;
    }
    .pre-querytid input, .post-querytid input { min-width: 120px; }

    /* Loop partition global config */
    .loop-partition-config {
      margin-top: 12px;
      background: #f0f6fa;
      border-radius: 8px;
      border: 1px dashed #0071C5;
      padding: 10px 12px;
    }
    .lp-row {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
    }
    .lp-table {
      width: 100%;
      border-collapse: collapse;
      background: #fff;
      border-radius: 8px;
      overflow: hidden;
      border: 1px solid #e0e6ed;
    }
    .lp-table th, .lp-table td {
      border-bottom: 1px solid #e0e6ed;
      padding: 8px;
      text-align: left;
      vertical-align: middle;
      font-size: 14px;
    }
    .lp-table th { background: #f8fafc; color: #333; }
    .lp-table tr:last-child td { border-bottom: none; }
    .lp-btn {
      background: #fff;
      color: #0071C5;
      border: 1px solid #0071C5;
      border-radius: 6px;
      padding: 2px 10px;
      cursor: pointer;
      transition: background 0.2s, color 0.2s;
      box-shadow: none;
      font-size: 13px;
      margin: 0;
    }
    .lp-btn:hover { background:#0071C5; color:#fff; }

    @media (max-width: 700px) {
      .container { padding: 12px 2vw; }
      textarea { min-width: 95vw; }
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
</head>
<body>
  <div class="intel-header">
    <img class="intel-logo" src="https://images.socialchorus.com/image/fetch/c_fill,dpr_2.0,b_rgb:ffffff,q_75,f_auto/https%3A%2F%2Fassets.socialchorus.com%2Fproduction%2F12717%2Fimages%2F17b859bf-d7f7-4e10-a717-df4fef1ddc67.png" alt="Intel Logo">
    <span style="font-size: 2rem; font-weight: 500;">PCAR3 Python Code Generator</span>
  </div>

  <div class="container">
    <label>PlistFile Name: <input type="text" id="plistfile" value="sample2.plist"></label>
    <button onclick="addPlb()">Add Plb</button>

    <!-- Loop partition global config -->
    <div class="loop-partition-config">
      <div class="lp-row">
        <label style="margin-left:0;">
          <input type="checkbox" id="loopPartitionEnabled" onchange="toggleLoopPartitionUI()"> Enable Loop Partition
        </label>
        <span style="color:#666;font-size:13px;">
          (Generates <code>name_of_instance</code> and <code>decode_par(name)</code>.)
        </span>
      </div>

      <div id="loopPartitionFields" style="display:none;">
        <div class="lp-row">
          <label style="margin-left:0;">name_of_instance:</label>
          <textarea id="nameOfInstance" placeholder="One per line, e.g.
extemca
intemca1
intemca2"></textarea>
        </div>

        <div style="color:#555;font-size:13px;margin:4px 0 10px 0;">
          decode_par mapping (name -> partition string). Example: <code>intemca27A</code> -> <code>INTCFG27A</code>
        </div>

        <table class="lp-table">
          <thead>
            <tr>
              <th style="width: 35%;">name</th>
              <th style="width: 45%;">partition (string)</th>
              <th style="width: 20%;">actions</th>
            </tr>
          </thead>
          <tbody id="decodeParTableBody"></tbody>
        </table>

        <div style="margin-top:10px;">
          <button class="lp-btn" onclick="addDecodeParRow()">Add mapping row</button>
        </div>
      </div>
    </div>

    <div id="plbContainer"></div>
    <button onclick="generateCode()">Generate Code</button>

    <h3>Generated Result:</h3>
    <pre id="codebox"></pre>
  </div>

  <div class="intel-footer">
    &copy; 2024 Your Company Name. All rights reserved.
  </div>

<script>
let plbCount = 0;

function addPlb() {
  plbCount++;
  const plbDiv = document.createElement('div');
  plbDiv.className = 'plb-block';
  plbDiv.id = 'plb' + plbCount;

  // IMPORTANT: keep this template simple (no nested ${...} inside)
  plbDiv.innerHTML = `
    <button class="delete-plb-btn" onclick="deletePlb('${plbDiv.id}')">Delete Plb</button>
    <div class="plb-header">
      <button class="plb-toggle-btn" onclick="togglePlb('${plbDiv.id}', this)">⌵</button>
      <label>Plb Name: <input type="text" class="plb-name" value="PList${String.fromCharCode(64+plbCount)}"></label>
    </div>

    <div class="plb-content">
      <div class="plb-row">
        <span class="param-group">
          <b>pre:</b>
          <label>preplist:<input type="text" class="preplist"></label>

          <label>prepattern:
            <select class="prepattern-mode" onchange="toggleInlinePatternMode(this, 'prepattern')">
              <option value="tuple">Tuple</option>
              <option value="tids">Tids</option>
              <option value="querytid">QueryTid</option>
            </select>
          </label>

          <span class="prepattern-tuple">
            <input type="text" class="prepattern-value" placeholder="e.g. 0000081">
          </span>

          <span class="prepattern-tids" style="display:none">
            <label>Tids: <input type="text" class="prepattern-tids-value" placeholder="e.g. 0000081"></label>
          </span>

          <span class="prepattern-querytid" style="display:none">
            <div class="pre-querytid">
              <label>testname: <input type="text" class="prepattern-querytid-testname" value=""></label>
              <label>testtype: <input type="text" class="prepattern-querytid-testtype" value=""></label>
            </div>
          </span>
        </span>
      </div>

      <div class="plb-row">
        <span class="param-group">
          <b>post:</b>
          <label>postplist:<input type="text" class="postplist"></label>

          <label>postpattern:
            <select class="postpattern-mode" onchange="toggleInlinePatternMode(this, 'postpattern')">
              <option value="tuple">Tuple</option>
              <option value="tids">Tids</option>
              <option value="querytid">QueryTid</option>
            </select>
          </label>

          <span class="postpattern-tuple">
            <input type="text" class="postpattern-value" placeholder="e.g. 0000081">
          </span>

          <span class="postpattern-tids" style="display:none">
            <label>Tids: <input type="text" class="postpattern-tids-value" placeholder="e.g. 0000081"></label>
          </span>

          <span class="postpattern-querytid" style="display:none">
            <div class="post-querytid">
              <label>testname: <input type="text" class="postpattern-querytid-testname" value=""></label>
              <label>testtype: <input type="text" class="postpattern-querytid-testtype" value=""></label>
            </div>
          </span>
        </span>
      </div>

      <div class="plb-row">
        <button onclick="addItem('${plbDiv.id}', 'pats')">Add Pats</button>
        <button onclick="addItem('${plbDiv.id}', 'preexecref')">Add PreExecRefPList</button>
        <button onclick="addItem('${plbDiv.id}', 'pre')">Add PreExecPat</button>
        <button onclick="addItem('${plbDiv.id}', 'ref')">Add RefPlb</button>
        <button onclick="addItem('${plbDiv.id}', 'postexecref')">Add PostExecRefPList</button>
        <button onclick="addItem('${plbDiv.id}', 'post')">Add PostExecPat</button>
        <button onclick="addItem('${plbDiv.id}', 'comment')">Add Comment</button>
      </div>

      <div class="item-list"></div>
    </div>
  `;

  document.getElementById('plbContainer').appendChild(plbDiv);

  setTimeout(() => {
    const itemList = plbDiv.querySelector('.item-list');
    if (window.Sortable) {
      Sortable.create(itemList, {
        animation: 150,
        ghostClass: 'drag-over',
        handle: '.drag-handle'
      });
    }
  }, 0);
}

function togglePlb(plbId, btn) {
  const plbDiv = document.getElementById(plbId);
  if (plbDiv) {
    plbDiv.classList.toggle('plb-collapsed');
    btn.textContent = plbDiv.classList.contains('plb-collapsed') ? '>' : '⌵';
  }
}

function deletePlb(plbId) {
  const plbDiv = document.getElementById(plbId);
  if (plbDiv) plbDiv.remove();
}

function toggleInlinePatternMode(sel, kind) {
  const wrapper = sel.closest('.param-group');
  const mode = sel.value;

  const tupleEl = wrapper.querySelector('.' + kind + '-tuple');
  const tidsEl = wrapper.querySelector('.' + kind + '-tids');
  const qtEl = wrapper.querySelector('.' + kind + '-querytid');

  if (tupleEl) tupleEl.style.display = mode === 'tuple' ? '' : 'none';
  if (tidsEl) tidsEl.style.display = mode === 'tids' ? '' : 'none';
  if (qtEl) qtEl.style.display = mode === 'querytid' ? '' : 'none';
}

function addDecodeParRow(name = '', partition = '') {
  const tbody = document.getElementById('decodeParTableBody');
  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td><input type="text" class="decode-name" value="${escapeHtml(name)}" placeholder="e.g. intemca27A" style="width: 95%;"></td>
    <td><input type="text" class="decode-partition" value="${escapeHtml(partition)}" placeholder="e.g. INTCFG27A" style="width: 95%;"></td>
    <td><button class="lp-btn" onclick="this.closest('tr').remove()">Remove</button></td>
  `;
  tbody.appendChild(tr);
}

function escapeHtml(s) {
  return (s || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;');
}

function toggleLoopPartitionUI() {
  const enabled = document.getElementById('loopPartitionEnabled').checked;
  document.getElementById('loopPartitionFields').style.display = enabled ? '' : 'none';
}

function addItem(plbId, type) {
  const itemDiv = document.createElement('div');
  itemDiv.className = 'item-block';
  itemDiv.setAttribute('data-type', type);

  let handle = `<span class="drag-handle">&#9776;</span>`;

  if (type === 'pats') {
    itemDiv.innerHTML = handle + `
      <div class="item-content">
        <b>Pats:</b>
        <select class="pats-mode" onchange="togglePatsMode(this)">
          <option value="default">Tuple</option>
          <option value="tids">Tids</option>
          <option value="querytid">QueryTid</option>
        </select>
        <span class="pats-default">
          <input type="text" class="pats-value" value="">
        </span>
        <span class="pats-tids" style="display:none">
          <label>Tids: <input type="text" class="tids-value" value=""></label>
          <label>chunk: <input type="text" class="tids-chunk" value=""></label>
        </span>
        <span class="pats-querytid" style="display:none">
          <label>testname: <input type="text" class="querytid-testname" value=""></label>
          <label>testtype: <input type="text" class="querytid-testtype" value=""></label>
          <label>chunk: <input type="text" class="querytid-chunk" value=""></label>
        </span>
      </div>
      <div class="item-actions">
        <button onclick="this.closest('.item-block').remove()">Delete</button>
      </div>
    `;
  } else if (type === 'pre' || type === 'post') {
    const prefix = type === 'pre' ? 'PreExecPat' : 'PostExecPat';
    itemDiv.innerHTML = handle + `
      <div class="item-content">
        <b>${prefix}:</b>
        <select class="${type}-mode" onchange="togglePrePostMode(this)">
          <option value="default">Tuple</option>
          <option value="tids">Tids</option>
          <option value="querytid">QueryTid</option>
        </select>
        <span class="${type}-default">
          <input type="text" class="${type}-value" value="">
        </span>
        <span class="${type}-tids" style="display:none">
          <label>Tids: <input type="text" class="${type}-tids-value" value=""></label>
          <label>chunk: <input type="text" class="${type}-tids-chunk" value=""></label>
        </span>
        <span class="${type}-querytid" style="display:none">
          <label>testname: <input type="text" class="${type}-querytid-testname" value=""></label>
          <label>testtype: <input type="text" class="${type}-querytid-testtype" value=""></label>
          <label>chunk: <input type="text" class="${type}-querytid-chunk" value=""></label>
        </span>
      </div>
      <div class="item-actions">
        <button onclick="this.closest('.item-block').remove()">Delete</button>
      </div>
    `;
  } else if (type === 'ref') {
    itemDiv.innerHTML = handle + `
      <div class="item-content">
        <b>RefPlb:</b>
        <label>Name: <input type="text" class="ref-name" value=""></label>
        <label>skip_preplistexec: <input type="checkbox" class="skip-pre"></label>
        <label>skip_postplistexec: <input type="checkbox" class="skip-post"></label>
      </div>
      <div class="item-actions">
        <button onclick="this.closest('.item-block').remove()">Delete</button>
      </div>
    `;
  } else if (type === 'preexecref') {
    itemDiv.innerHTML = handle + `
      <div class="item-content">
        <b>PreExecRefPList:</b>
        <label>Name: <input type="text" class="preexecref-name" value=""></label>
      </div>
      <div class="item-actions">
        <button onclick="this.closest('.item-block').remove()">Delete</button>
      </div>
    `;
  } else if (type === 'postexecref') {
    itemDiv.innerHTML = handle + `
      <div class="item-content">
        <b>PostExecRefPList:</b>
        <label>Name: <input type="text" class="postexecref-name" value=""></label>
      </div>
      <div class="item-actions">
        <button onclick="this.closest('.item-block').remove()">Delete</button>
      </div>
    `;
  } else if (type === 'comment') {
    itemDiv.innerHTML = handle + `
      <div class="item-content">
        <b>Comment:</b>
        <label>Content: <input type="text" class="comment-content" value=""></label>
      </div>
      <div class="item-actions">
        <button onclick="this.closest('.item-block').remove()">Delete</button>
      </div>
    `;
  }
  document.querySelector('#' + plbId + ' .item-list').appendChild(itemDiv);
}

function togglePatsMode(sel) {
  const parent = sel.closest('.item-content');
  parent.querySelector('.pats-default').style.display = sel.value === 'default' ? '' : 'none';
  parent.querySelector('.pats-tids').style.display = sel.value === 'tids' ? '' : 'none';
  parent.querySelector('.pats-querytid').style.display = sel.value === 'querytid' ? '' : 'none';
}
function togglePrePostMode(sel) {
  const type = sel.className.split('-')[0];
  const parent = sel.closest('.item-content');
  parent.querySelector('.' + type + '-default').style.display = sel.value === 'default' ? '' : 'none';
  parent.querySelector('.' + type + '-tids').style.display = sel.value === 'tids' ? '' : 'none';
  parent.querySelector('.' + type + '-querytid').style.display = sel.value === 'querytid' ? '' : 'none';
}

function pyEscapeSingle(s) {
  return (s || '').replace(/\\/g,'\\\\').replace(/'/g,"\\'");
}
function parseNameListFromTextarea(txt) {
  return (txt || '').split(/\r?\n/).map(s => s.trim()).filter(Boolean);
}

function buildDecodeParFunction() {
  const rows = Array.from(document.querySelectorAll('#decodeParTableBody tr'));
  const pairs = rows.map(tr => {
    const name = tr.querySelector('.decode-name')?.value?.trim() || '';
    const part = tr.querySelector('.decode-partition')?.value?.trim() || '';
    return { name, part };
  }).filter(x => x.name && x.part);

  let code = '';
  code += '# subroutine\n';
  code += 'def decode_par(name):\n';
  if (pairs.length === 0) {
    code += '    return str("NOMATCH")\n\n';
    return code;
  }
  pairs.forEach((p, idx) => {
    const head = idx === 0 ? 'if' : 'elif';
    code += '    ' + head + ' name == "' + pyEscapeSingle(p.name) + '":\n';
    code += '        par = str("' + pyEscapeSingle(p.part) + '")\n';
  });
  code += '    else:\n';
  code += '        par = str("NOMATCH")\n';
  code += '    return par\n\n';
  return code;
}

function buildInlinePatternExpr(plbDiv, kind) {
  const mode = plbDiv.querySelector('.' + kind + '-mode')?.value || 'tuple';

  if (mode === 'tuple') {
    const v = plbDiv.querySelector('.' + kind + '-value')?.value?.trim();
    if (!v) return '';
    return "Pats(['" + pyEscapeSingle(v) + "'])";
  }
  if (mode === 'tids') {
    const v = plbDiv.querySelector('.' + kind + '-tids-value')?.value?.trim();
    if (!v) return '';
    return "Pats(Tids(['" + pyEscapeSingle(v) + "']))";
  }
  if (mode === 'querytid') {
    const testname = plbDiv.querySelector('.' + kind + '-querytid-testname')?.value?.trim() || '';
    const testtype = plbDiv.querySelector('.' + kind + '-querytid-testtype')?.value?.trim() || '';
    if (!testname && !testtype) return '';
    const args = [];
    if (testname) args.push("testname='" + pyEscapeSingle(testname) + "'");
    if (testtype) args.push("testtype='" + pyEscapeSingle(testtype) + "'");
    return 'Pats(QueryTid(' + args.join(', ') + '))';
  }
  return '';
}

function buildPatsExprFromItem(itemDiv) {
  const mode = itemDiv.querySelector('.pats-mode')?.value || 'default';
  if (mode === 'default') {
    const val = itemDiv.querySelector('.pats-value')?.value?.trim();
    if (!val) return '';
    return "Pats(['" + pyEscapeSingle(val) + "'])";
  } else if (mode === 'tids') {
    const tids = itemDiv.querySelector('.tids-value')?.value?.trim();
    if (!tids) return '';
    const chunk = itemDiv.querySelector('.tids-chunk')?.value?.trim() || '';
    const patsArgs = [];
    if (chunk) patsArgs.push('chunk="' + pyEscapeSingle(chunk) + '"');
    return "Pats(Tids(['" + pyEscapeSingle(tids) + "'])" + (patsArgs.length ? ', ' + patsArgs.join(', ') : '') + ')';
  } else if (mode === 'querytid') {
    const testname = itemDiv.querySelector('.querytid-testname')?.value?.trim() || '';
    const testtype = itemDiv.querySelector('.querytid-testtype')?.value?.trim() || '';
    if (!testname && !testtype) return '';
    const qtArgs = [];
    if (testname) qtArgs.push("testname='" + pyEscapeSingle(testname) + "'");
    if (testtype) qtArgs.push("testtype='" + pyEscapeSingle(testtype) + "'");
    const chunk = itemDiv.querySelector('.querytid-chunk')?.value?.trim() || '';
    const extra = [];
    if (chunk) extra.push('chunk="' + pyEscapeSingle(chunk) + '"');
    return 'Pats(QueryTid(' + qtArgs.join(', ') + ')' + (extra.length ? ', ' + extra.join(', ') : '') + ')';
  }
  return '';
}

function buildPrePostExprFromItem(itemDiv, type) {
  const prefix = type === 'pre' ? 'PreExecPat' : 'PostExecPat';
  const mode = itemDiv.querySelector('.' + type + '-mode')?.value || 'default';

  if (mode === 'default') {
    const val = itemDiv.querySelector('.' + type + '-value')?.value?.trim();
    if (!val) return '';
    return prefix + "(pat=Pats(['" + pyEscapeSingle(val) + "']))";
  } else if (mode === 'tids') {
    const tids = itemDiv.querySelector('.' + type + '-tids-value')?.value?.trim();
    if (!tids) return '';
    const chunk = itemDiv.querySelector('.' + type + '-tids-chunk')?.value?.trim() || '';
    const patsArgs = [];
    if (chunk) patsArgs.push('chunk="' + pyEscapeSingle(chunk) + '"');
    return prefix + "(pat=Pats(Tids(['" + pyEscapeSingle(tids) + "'])" + (patsArgs.length ? ', ' + patsArgs.join(', ') : '') + '))';
  } else if (mode === 'querytid') {
    const testname = itemDiv.querySelector('.' + type + '-querytid-testname')?.value?.trim() || '';
    const testtype = itemDiv.querySelector('.' + type + '-querytid-testtype')?.value?.trim() || '';
    if (!testname && !testtype) return '';
    const qtArgs = [];
    if (testname) qtArgs.push("testname='" + pyEscapeSingle(testname) + "'");
    if (testtype) qtArgs.push("testtype='" + pyEscapeSingle(testtype) + "'");
    const chunk = itemDiv.querySelector('.' + type + '-querytid-chunk')?.value?.trim() || '';
    const extra = [];
    if (chunk) extra.push('chunk="' + pyEscapeSingle(chunk) + '"');
    return prefix + '(pat=Pats(QueryTid(' + qtArgs.join(', ') + ')' + (extra.length ? ', ' + extra.join(', ') : '') + '))';
  }
  return '';
}

function generateCode() {
  const plistfile = document.getElementById('plistfile').value;

  let code = "from veplib.plist_builder_pcar3 import PlistFile, Plb, Pats, Tids, QueryTid, pcar3, Amble, Comment, RefPlb, NameFilter, PreExecPat, PostExecPat, PreExecRefPList, PostExecRefPList\n";
  code += 'pcar3.tos_ver = "tos4"\n\n';

  const loopEnabled = document.getElementById('loopPartitionEnabled').checked;
  if (loopEnabled) {
    const names = parseNameListFromTextarea(document.getElementById('nameOfInstance').value);
    code += "name_of_instance = [" + names.map(n => "'" + pyEscapeSingle(n) + "'").join(', ') + "]\n\n";
    code += buildDecodeParFunction();
  }

  code += "level0 = PlistFile('" + pyEscapeSingle(plistfile) + "')\n";

  const plbDivs = Array.from(document.querySelectorAll('.plb-block'));
  plbDivs.forEach((plbDiv) => {
    const plbName = plbDiv.querySelector('.plb-name').value;
    let plbParams = [];

    const preplist = plbDiv.querySelector('.preplist').value;
    if (preplist) plbParams.push('preplist="' + pyEscapeSingle(preplist) + '"');

    const postplist = plbDiv.querySelector('.postplist').value;
    if (postplist) plbParams.push('postplist="' + pyEscapeSingle(postplist) + '"');

    const prepatternExpr = buildInlinePatternExpr(plbDiv, 'prepattern');
    if (prepatternExpr) plbParams.push('prepattern=' + prepatternExpr);

    const postpatternExpr = buildInlinePatternExpr(plbDiv, 'postpattern');
    if (postpatternExpr) plbParams.push('postpattern=' + postpatternExpr);

    code += 'level1 = level0.add(Plb("' + pyEscapeSingle(plbName) + '"' + (plbParams.length ? ', ' + plbParams.join(', ') : '') + '))\n';

    plbDiv.querySelectorAll('.item-list .item-block').forEach(itemDiv => {
      const type = itemDiv.getAttribute('data-type');

      if (type === 'pats') {
        const expr = buildPatsExprFromItem(itemDiv);
        if (expr) code += 'level1.add(' + expr + ')\n';
      } else if (type === 'pre' || type === 'post') {
        const expr2 = buildPrePostExprFromItem(itemDiv, type);
        if (expr2) code += 'level1.add(' + expr2 + ')\n';
      } else if (type === 'ref') {
        const refName = itemDiv.querySelector('.ref-name').value;
        const skipPre = itemDiv.querySelector('.skip-pre').checked;
        const skipPost = itemDiv.querySelector('.skip-post').checked;
        let opts = [];
        if (skipPre) opts.push('skip_preplistexec=True');
        if (skipPost) opts.push('skip_postplistexec=True');
        code += 'level1.add(RefPlb("' + pyEscapeSingle(refName) + '"' + (opts.length ? ', ' + opts.join(', ') : '') + '))\n';
      } else if (type === 'preexecref') {
        const name = itemDiv.querySelector('.preexecref-name').value;
        if (name) code += 'level1.add(PreExecRefPList("' + pyEscapeSingle(name) + '"))\n';
      } else if (type === 'postexecref') {
        const name = itemDiv.querySelector('.postexecref-name').value;
        if (name) code += 'level1.add(PostExecRefPList("' + pyEscapeSingle(name) + '"))\n';
      } else if (type === 'comment') {
        const content = itemDiv.querySelector('.comment-content').value;
        if (content) code += "level1.add(Comment('" + pyEscapeSingle(content) + "'))\n";
      }
    });

    code += "\n";
  });

  code += 'if (__name__ == "__main__"):\n    pcar3.process()\n    print("Summary")\n    pcar3.report(detail=True)\n    print(pcar3.gen_plist_preview())\n';
  document.getElementById('codebox').textContent = code;
}

// Seed example mapping row
addDecodeParRow('extemca', 'EXTEST');
</script>
</body>
</html>
